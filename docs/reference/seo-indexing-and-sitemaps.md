# SEO, Indexing, and Sitemaps

Purpose: document how this repo handles **indexing safety** (prod vs non-prod), **preview noindex**, canonical URLs, and `/sitemap.xml` generation.

## Goals

- Production deploys are indexable.
- Non-production deploys (local/dev/preview/staging) are **noindex** by default.
- Preview and API routes are always **noindex**.
- Preview pages canonicalize to their published URL to avoid duplicate-content signals.
- Unknown published routes return a true HTTP `404` while rendering the CMS-driven 404 page.

## Indexing strategy (defense in depth)

We rely on multiple layers so an accidental misconfiguration in one place doesn’t leak draft content into indexes:

1. HTTP headers
   - Configured in [next.config.mjs](../../next.config.mjs).
   - `/sb-preview/*` and `/api/*` always get `X-Robots-Tag: noindex, nofollow, noarchive` and `Cache-Control: no-store`.
   - Non-production deploys also get a global `X-Robots-Tag: noindex, nofollow, noarchive`.

2. Metadata
   - Published layout emits indexable `robots` only in production: [src/app/(pages)/layout.tsx](<../../src/app/(pages)/layout.tsx>).
   - Preview route metadata is always `noindex`: [src/app/(preview)/sb-preview/[...slug]/page.tsx](<../../src/app/(preview)/sb-preview/[...slug]/page.tsx>).

3. robots.txt
   - Generated by [src/app/robots.ts](../../src/app/robots.ts).
   - Production: allows crawling `/` but blocks `/sb-preview/` and `/api/`.
   - Non-production: disallows crawling entirely.

## Environment detection

We treat a deploy as non-production when:

- `NODE_ENV !== 'production'`, OR
- `DEPLOY_ENV` / `NEXT_PUBLIC_DEPLOY_ENV` is set and not `production` (useful for self-hosted staging), OR
- `VERCEL_ENV` is set and not `production`.

See [.env.example](../../.env.example) for the canonical env var list.

## Canonical URLs

- Published routes emit canonical URLs via `alternates.canonical`.
- Preview routes under `/sb-preview/*` set `alternates.canonical` to the matching **published** URL.

### Canonical on 404 responses

For **true** HTTP `404` responses, Next.js App Router may omit the HTML `<link rel="canonical">` tag even when `alternates.canonical` is set.

In this repo, 404 canonicals are therefore communicated via the HTTP `Link` header:

- `Link: <https://your-domain.example/missing-path>; rel="canonical"`

When validating 404 canonicals, check response headers (not the rendered HTML).

404 responses also explicitly discourage indexing and caching:

- `X-Robots-Tag: noindex, follow, noarchive`
- `Cache-Control: no-store, max-age=0`

Note: we use `follow` here (instead of `nofollow`) as a common best-practice default for 404s.

Quick check (Windows): `curl -I https://your-domain.example/asdf | findstr /I "^Link:"`

The canonical helpers live in:

- [src/lib/site/canonicalPath.ts](../../src/lib/site/canonicalPath.ts)
- [src/lib/site/canonicalUrl.ts](../../src/lib/site/canonicalUrl.ts)

## Sitemap

- Sitemap is served at `/sitemap.xml` by [src/app/sitemap.ts](../../src/app/sitemap.ts).
- It pulls Storyblok links via `cdn/links` using [src/lib/storyblok/api/storyblokServer.ts](../../src/lib/storyblok/api/storyblokServer.ts) (`getLinks`).
- It excludes folders and internal slugs (preview/api paths, `site-config`, etc), includes `/`, and sorts deterministically.
- The CMS-driven 404 story slug is excluded from the sitemap.
- If Storyblok tokens aren’t configured, the route returns a minimal sitemap rather than failing builds.

## CMS-driven 404 story slug

By default, the CMS 404 page is expected to be a published Storyblok story with the slug `error-404`.

You can override this via:

- `STORYBLOK_404_SLUG` (default: `error-404`)

robots.txt advertises the sitemap via `sitemap: ${SITE_URL}/sitemap.xml`.

## Quick verification

- `GET /robots.txt` (production should allow `/` and disallow `/sb-preview/` and `/api/`)
- `GET /sitemap.xml` (should render and include deterministic URLs)
- `GET /sb-preview/home` (should be `noindex` and `no-store`)
